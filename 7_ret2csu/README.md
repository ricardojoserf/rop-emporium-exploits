# ret2csu

Link: https://ropemporium.com/challenge/ret2csu.html

Description: *Call the ret2win() function, the caveat this time is that the third argument (which you know by now is stored in the rdx register on x86_64 Linux) must be 0xdeadcafebabebeef*

-----------------------

## 1. Calculating RIP overwrite offset

First, we check with GDB that the offset is still 40. It seems so given that with 41 characters we see only one "41" in RIP registry::

![a](images/Screenshot_1.jpg)

## 2. Studying the binary

Then we see the address of *ret2win()* is 0x4007b1:

![a](images/Screenshot_2.jpg)

We will also check that it is a dynamically compiled file and the GCC version used for compiling it, which may be important from the description of the challenge:

![a](images/Screenshot_2.jpg)

## 3. Ret-2-csu

From [here](https://i.blackhat.com/briefings/asia/2018/asia-18-Marco-return-to-csu-a-new-method-to-bypass-the-64-bit-Linux-ASLR-wp.pdf), *it is not a programming error on the code that implements the ASLR, but a exploitation method that it is possible because of the "attached code" by the linker (...). The problem appears when an application is Dynamically compiled, which represents 99% of all applications. More precisely when the linker "attaches code" to the ELF executable that is not coming from the source code of the application.*

A gadget in *_libc_csu_init()* allows to control some registers:

```
112a: 5b pop %rbx GADGET 1
112b: 5d pop %rbp
112c: 41 5c pop %r12
112e: 41 5d pop %r13
1130: 41 5e pop %r14
1132: 41 5f pop %r15
1134: c3 retq
```
And those allow to control RDX, RSI, RDI and call the address calculated as (%r12 + (%rbx * 8) ):

```
1110: 4c 89 ea mov %r13,%rdx GADGET 2
1113: 4c 89 f6 mov %r14,%rsi
1116: 44 89 ff mov %r15d,%edi
1119: 41 ff 14 dc callq *(%r12,%rbx,8)
```

From the "callme" challenge we know that the arguments are pushed to the stack in the 32 bits architecture and stored in registers in the 64 bits one ([source](https://uclibc.org/docs/psABI-x86_64.pdf)):

- First Argument: RDI

- Second Argument: RSI

- Third Argument: RDX




---------------

References: 

- https://i.blackhat.com/briefings/asia/2018/asia-18-Marco-return-to-csu-a-new-method-to-bypass-the-64-bit-Linux-ASLR-wp.pdf

- https://ctf-wiki.github.io/ctf-wiki/pwn/linux/stackoverflow/medium-rop/

- https://bananamafia.dev/post/x64-rop-redpwn/
